function reloadSession(e){var r=$.Deferred();return e.sessionStore.sessions[e.sessionID]?(e.session.reload(function(){var s=e.session.player._id;return GLOBAL.GYM.force[s]?(GLOBAL.GYM.force[s]=!1,void require("./routes/auth")["default"].handler(e.session,{playerId:s,authKey:123,force:!0}).then(function(){r.resolve()})):void r.resolve()}),r):(r.resolve(),r)}function handler(e,r,s,o){function n(s){var o=s.message||s,n={error:o,url:e.url};s.stack&&(console.log(s.stack),Db.insert("errors",{_id:(new Date).getTime(),playerId:e.session.player._id,side:"server",message:o,stack:s.stack})),r.jsonp(JSON.stringify(n))}function i(s){var o={data:s||!0,url:e.url};r.jsonp(JSON.stringify(o))}reloadSession(e).then(function(){try{var r=require("./routes/auth"),t=e.session;if(s!==r&&!t.player)throw"ERR_UNAUTH";var a=getMethodName(e,s),u=s[a];if(!u)return void n("Method "+a+" is not exists");var l=t.player;l&&(PlayersCollection.initStress(t.player),PlayersCollection.initFrazzle(t.player),PlayersCollection.initTonus(t.player),PlayersCollection.initAwards(t.player));var c=getParams(e,u);u.handler(t,c,e).then(function(r){"refs"!==o&&require("./controllers/ach").handler(t,r,e),t.isDirty?(t.isDirty=!1,t.save(function(){i(r)}),Player.update(t.player._id,t.player)):i(r)},n)}catch(d){n(d)}})}function getMethodName(e,r){for(var s in e.query)if("method"===s)return e.query[s];return"default"}function getParams(e,r){var s={};if(!r.params)return s;for(var o in r.params){var n=r.params[o],i=e.query[o];if(n.required&&void 0===i)throw ERR_PARAMS;n.parseMethod&&(i=n.parseMethod(i)),s[o]=i}return s}var Express=require("express"),Db=require("./db"),Compression=require("compression"),Session=require("express-session"),GymDb=require("./gymdb/gymdb"),$=require("jquery-deferred"),Player=require("./controllers/player"),Coach=require("./controllers/coach"),PlayersCollection=require("./gymdb/collections/players");exports.start=function(e){var r=Express();r.use(Compression()),r.use(Session({genid:function(e){var r=e.query.playerId;return r},secret:"iuBviX21"}));var s=["auth","refs","workout","job","self","top","coach","buy","real","god","payment","inv","error","comp"];return $.Deferred(function(o){try{GymDb.init(GLOBAL.GYM.instance).then(function(){s.forEach(function(e){var s=require("./routes/"+e);r.get("/"+e,function(r,o){handler(r,o,s,e)})});for(var n in GLOBAL.GYM.JOBS){var i=require("./jobs/"+n);i.init(),setInterval(i.run,GLOBAL.GYM.JOBS[n])}r.listen(e),o.resolve()},o.reject)}catch(n){o.reject(n)}})};