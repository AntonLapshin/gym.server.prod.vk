function getStress(e){var r=Db.getRefs().muscles,t=function(){for(var e=0,t=0;t<r.length;t++)e+=r[t].power;return e},a=t(),l=0;PlayersCollection.initStress(e);for(var n=0;n<e["private"].stress.length;n++){var s=e["private"].stress[n],i=r[n];l+=i.power*s/a}return l}function update(e){var r=module.exports.getRegen(e);0==r.frazzle&&(r.frazzle=.3),0==r.energy&&(r.energy=.3);var t=new Date,a=(new Date-e["private"].reg.lastUpdateTime)/36e5,l=$.round(r.frazzle*a),n=$.round(r.tonus*a),s=$.round(e["private"].energy+r.energy*a);s>PlayersCollection.ENERGY_MAX&&(s=PlayersCollection.ENERGY_MAX),e["private"].garb+=Math.round(r.garb*a),e["private"].garb>GARB_MAX&&(e["private"].garb=GARB_MAX),e["private"].energy=s,e["private"].reg.lastUpdateTime=t.getTime();for(var i=e["private"].frazzle,o=e["private"].tonus,u=0;15>=u;u++){var p=i[u];p=$.round(p-l),0>p&&(p=0),i[u]=p;var v=o[u];if(v=$.round(v-n),0>v&&(v=0),0==v&&o[u]>0&&o[u]-v>r.tonus*a*1.2){var g="tonus["+u+"] = "+o[u]+"; interval = "+a+"; tonusDecrease = "+n+"; ";Err["default"].handler({player:e},{message:g}),v=o[u]}o[u]=v}}function getLevelChange(e,r){var t=new Date,a=Curve.getLevelRequirements(e["public"].level),l=(e["private"].growth||e["private"].growt||0)+r.growth;if(e["public"].level>0&&a>l){var n=DateHelper.addHoursClone(new Date(e["private"].reg.lastCheckLevelUpTime),GLOBAL.GYM.CHECK_LEVELUP_PERIOD);if(n>t)return-2}e["private"].reg.lastCheckLevelUpTime=t.getTime();var s=0;if(l>=a)e["public"].level++,e["private"].growth=0,e["private"].energy=PlayersCollection.ENERGY_MAX,s=1;else{if(0===e["public"].level)return-2;e["private"].growth=l}for(var i=0;15>=i;i++)e["private"].frazzle[i]=0,e["private"].stress[i]=0;return e["private"].rest=[],e["private"].food=[],e["private"].stimul=[],0===s&&0===e["public"].level?-2:s}var Db=require("../db"),DateHelper=require("../controllers/date"),PlayersCollection=require("../gymdb/collections/players"),Player=require("../controllers/player"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),Mass=require("../controllers/mass"),Err=require("./error"),MAX_LEVEL=67,GARB_MAX=14,BONUS_MAX=10;module.exports={getPlayerStat:function(e){for(var r=e["public"].level,t=getStress(e),a=(Curve.getMass(r),Stimul.getFood(e)),l=0,n=0;n<e["private"].rest.length;n++){var s=e["private"].rest[n],i=Db.getRefs().shop[1].items[s];i&&(l+=i.coeff)}l>1&&(l=1);var o=1+Stimul.getGrowth(e),u=t*l*a*o;return{period:"each "+GLOBAL.GYM.CHECK_LEVELUP_PERIOD+" hours",growth:u,stress:t,rest:l,food:a,stimulGrowth:o}},getRegen:function(e){for(var r=0,t=0;t<e["private"].rest.length;t++){var a=e["private"].rest[t],l=Db.getRefs().shop[1].items[a];l&&(r+=l.coeff)}r>1&&(r=1);var n=Stimul.getRegen(e),s={energy:GLOBAL.GYM.REG_ENERGY*(r+n)*PlayersCollection.ENERGY_MAX,frazzle:GLOBAL.GYM.REG_FRAZZLE*(r+n),tonus:GLOBAL.GYM.REG_TONUS,garb:GLOBAL.GYM.REG_GARB};return s.energy<GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX&&(s.energy=GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX),s.frazzle<GLOBAL.GYM.REG_FRAZZLE_SLOW&&(s.frazzle=GLOBAL.GYM.REG_FRAZZLE_SLOW),s},get:{params:{friends:{parseMethod:parseInt},garb:{parseMethod:parseInt},bonus:{parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),a=e.player;r.bonus&&(a["private"].money+=Math.min(r.bonus,BONUS_MAX),e.isDirty=!0),r.garb&&(a["private"].garb-=r.garb,a["private"].garb<0&&(a["private"].garb=0),e.isDirty=!0),r.friends&&(a["private"].friends=r.friends,e.isDirty=!0);var l=new Date,n=a["private"].reg,s=DateHelper.addMinutesClone(new Date(n.lastUpdateTime),GLOBAL.GYM.UPDATE_PERIOD);if(s>l)return t.resolve({success:!0,player:a}),t;var i=module.exports.getPlayerStat(a),o=Mass.getMass(a,i.growth);a["public"].mass=o,a["public"].sum=Rank.getSum(a);var u={success:!0,player:a};if(s.getDay()!=l.getDay()){var p=Rank.getSalary(a);if(p&&(u.money=p.money,a["private"].money+=p.money,p.gold>0&&(u.gold=p.gold,a["private"].gold+=p.gold)),a["public"].coach){var v=a["public"].coach.q,g=a["public"].level/50*10,c=2*(Rank.getRank(a)||0)+1,d=Math.floor((g+c+1)/5),f=10*d;0===f&&(f=5),v>f&&(v=f),u.money||(u.money=0),u.money+=v,a["private"].money+=v}}update(a);var y=getLevelChange(a,i);if(1===y){var G=Rank.update(a);null!==G&&(u.rank=G)}return e.isDirty=!0,-2!=y&&(u.levelChange=y),t.resolve(u),t}},getPlayer:{params:{playerId:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred();return Player.find(r.playerId,{_id:1,"public":1}).then(function(e){t.resolve({success:!0,player:e})}),t}},getPlayers:{params:{playerIds:{required:!0,parseMethod:function(e){var r=[];return e.split(",").forEach(function(e){r.push(parseInt(e))}),r}}},handler:function(e,r){var t=$.Deferred();return Player.getPlayers(r.playerIds).then(function(e){t.resolve({success:!0,players:e})}),t}}};