function getStress(e){var r=Db.getRefs().muscles,t=function(){for(var e=0,t=0;t<r.length;t++)e+=r[t].power;return e},a=t(),l=0;PlayersCollection.initStress(e);for(var s=0;s<e["private"].stress.length;s++){var n=e["private"].stress[s],i=r[s];l+=i.power*n/a}return l}function update(e){var r=module.exports.getRegen(e);0==r.frazzle&&(r.frazzle=.3),0==r.energy&&(r.energy=.3);var t=new Date,a=DateHelper.intervalHours(Date.parse(t)-Date.parse(new Date(e["private"].reg.lastUpdateTime))),l=$.round(r.frazzle*a),s=$.round(r.tonus*a),n=$.round(e["private"].energy+r.energy*a);n>PlayersCollection.ENERGY_MAX&&(n=PlayersCollection.ENERGY_MAX),e["private"].garb+=Math.round(r.garb*a),e["private"].garb>GARB_MAX&&(e["private"].garb=GARB_MAX),e["private"].energy=n,e["private"].reg.lastUpdateTime=t.getTime();for(var i=0;15>=i;i++){var o=e["private"].frazzle[i];o=$.round(o-l),0>o&&(o=0),e["private"].frazzle[i]=o;var p=e["private"].tonus[i];p=$.round(p-s),0>p&&(p=0),e["private"].tonus[i]=p}}function getLevelChange(e,r){var t=new Date,a=Curve.getLevelRequirements(e["public"].level),l=(e["private"].growth||e["private"].growt||0)+r.growth;if(e["public"].level>0&&a>l){var s=DateHelper.addHoursClone(new Date(e["private"].reg.lastCheckLevelUpTime),GLOBAL.GYM.CHECK_LEVELUP_PERIOD);if(s>t)return-2}e["private"].reg.lastCheckLevelUpTime=t.getTime();var n=0;if(l>=a)e["public"].level++,e["private"].growth=0,e["private"].energy=PlayersCollection.ENERGY_MAX,n=1;else{if(0===e["public"].level)return-2;e["private"].growth=l}for(var i=0;15>=i;i++)e["private"].frazzle[i]=0,e["private"].stress[i]=0;return e["private"].rest=[],e["private"].food=[],e["private"].stimul=[],0===n&&0===e["public"].level?-2:n}var Db=require("../db"),DateHelper=require("../controllers/date"),PlayersCollection=require("../gymdb/collections/players"),Player=require("../controllers/player"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),Mass=require("../controllers/mass"),MAX_LEVEL=67,GARB_MAX=14,BONUS_MAX=10;module.exports={getPlayerStat:function(e){for(var r=e["public"].level,t=getStress(e),a=(Curve.getMass(r),Stimul.getFood(e)),l=0,s=0;s<e["private"].rest.length;s++){var n=e["private"].rest[s],i=Db.getRefs().shop[1].items[n];i&&(l+=i.coeff)}l>1&&(l=1);var o=1+Stimul.getGrowth(e),p=t*l*a*o;return{period:"each "+GLOBAL.GYM.CHECK_LEVELUP_PERIOD+" hours",growth:p,stress:t,rest:l,food:a,stimulGrowth:o}},getRegen:function(e){for(var r=0,t=0;t<e["private"].rest.length;t++){var a=e["private"].rest[t],l=Db.getRefs().shop[1].items[a];l&&(r+=l.coeff)}r>1&&(r=1);var s=Stimul.getRegen(e),n={energy:GLOBAL.GYM.REG_ENERGY*(r+s)*PlayersCollection.ENERGY_MAX,frazzle:GLOBAL.GYM.REG_FRAZZLE*(r+s),tonus:GLOBAL.GYM.REG_TONUS,garb:GLOBAL.GYM.REG_GARB};return n.energy<GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX&&(n.energy=GLOBAL.GYM.REG_ENERGY_SLOW*PlayersCollection.ENERGY_MAX),n.frazzle<GLOBAL.GYM.REG_FRAZZLE_SLOW&&(n.frazzle=GLOBAL.GYM.REG_FRAZZLE_SLOW),n},get:{params:{friends:{parseMethod:parseInt},garb:{parseMethod:parseInt},bonus:{parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),a=e.player;r.bonus&&(a["private"].money+=Math.min(r.bonus,BONUS_MAX),e.isDirty=!0),r.garb&&(a["private"].garb-=r.garb,a["private"].garb<0&&(a["private"].garb=0),e.isDirty=!0),r.friends&&(a["private"].friends=r.friends,e.isDirty=!0);var l=new Date,s=a["private"].reg,n=DateHelper.addMinutesClone(new Date(s.lastUpdateTime),GLOBAL.GYM.UPDATE_PERIOD);if(n>l)return t.resolve({success:!0,player:a}),t;var i=module.exports.getPlayerStat(a),o=Mass.getMass(a,i.growth);a["public"].mass=o,a["public"].sum=Rank.getSum(a);var p={success:!0,player:a};if(n.getDay()!=l.getDay()){var u=Rank.getSalary(a);if(u&&(p.money=u.money,a["private"].money+=u.money,u.gold>0&&(p.gold=u.gold,a["private"].gold+=u.gold)),a["public"].coach){var v=a["public"].coach.q,g=a["public"].level/67*10,c=2*(Rank.getRank(a)||0),d=Math.floor((g+c+1)/5),f=10*d;0===f&&(f=5),v>f&&(v=f),p.money||(p.money=0),p.money+=v,a["private"].money+=v}}update(a);var y=getLevelChange(a,i);if(1===y){var G=Rank.update(a);null!==G&&(p.rank=G)}return e.isDirty=!0,-2!=y&&(p.levelChange=y),t.resolve(p),t}},getPlayer:{params:{playerId:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred();return Player.find(r.playerId,{_id:1,"public":1}).then(function(e){t.resolve({success:!0,player:e})}),t}},getPlayers:{params:{playerIds:{required:!0,parseMethod:function(e){var r=[];return e.split(",").forEach(function(e){r.push(parseInt(e))}),r}}},handler:function(e,r){var t=$.Deferred();return Player.getPlayers(r.playerIds).then(function(e){t.resolve({success:!0,players:e})}),t}}};