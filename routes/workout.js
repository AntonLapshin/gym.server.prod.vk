function setFrazzle(e,r,t,a){var s=e["private"].frazzle,i=e["private"].stress,n=e["private"].tonus,u=a/r.energy*.2;r.body.forEach(function(e,r){var a=s[e._id]+e.stress*u;a>1&&(a=1);var p=i[e._id]+(e.stress<.5?e.stress/5:e.stress)*t;p>1&&(p=1);var o=e._id,c=.025*p;c-=c*(n[o]/TONUS_MAX),n[o]+=$.round(c),n[o]>TONUS_MAX&&(n[o]=TONUS_MAX),s[o]=$.round(a),i[o]=$.round(p)})}var Db=require("../db"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Coach=require("../controllers/coach"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10,TONUS_MAX=10;module.exports={getTotalWeightMax:function(e,r){for(var t=e["public"].level,a=e["private"].tonus,s=Db.getRefs().exercises[r],i=Curve.getWeightMax(t,r),n=Stimul.getPower(e),u=0,p=0,o=0,c=0;c<s.body.length;c++){var f=s.body[c],v=Db.getRefs().muscles[f._id],d=a?a[f._id]:0,l=v.power*f.stress,E=l*e["private"].frazzle[f._id],M=l*d;u+=l,p+=E,o+=M}var g=p/u,a=o/u,_=i+.1*i*n-.1*i*g+.1*i*a;return _},getRepeatsAndEff:function(e,r,t,a){var s=Curve.getRepeatsMax(e["public"].level,r,t,a),i=Curve.getRepeatsEffect(s);return{repeatsMax:s,weightEffect:i}},auto:{params:{rate:{required:!0,parseMethod:parseInt},eff:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=$.Deferred(),a=e.player,s=r.rate,i=r.eff;if(a["private"].money<s)return t.resolve({success:!1}),t;var n={success:!0},u=a["private"].energy/a["private"].energyMax;i=u*i;for(var p=a["private"].frazzle,o=a["private"].stress,c=a["private"].tonus,f=0;15>=f;f++){p[f]+=$.round(i),o[f]+=$.round(i),p[f]>1&&(p[f]=1),o[f]>1&&(o[f]=1);var v=.01*i;v-=v*(c[f]/TONUS_MAX),c[f]+=$.round(v),c[f]>TONUS_MAX&&(c[f]=TONUS_MAX)}return e.isDirty=!0,n.effect=i,n.energy=-a["private"].energy,n.money=-s,a["private"].energy=0,Coach.earn(a["private"].coach,s),t.resolve(n),t}},execute:{params:{gymId:{required:!0,parseMethod:parseInt},exerciseId:{required:!0,parseMethod:parseInt},weight:{required:!0,parseMethod:parseFloat},repeats:{required:!0,parseMethod:parseInt},comp:{parseMethod:parseInt}},handler:function(e,r){var t=e.player,a=r.comp,s=r.gymId,i=r.exerciseId,n=r.weight,u=r.repeats,p=$.Deferred(),o=Db.getRefs().gyms[s];if(!a&&-1==o.exercises.indexOf(i))return p.reject("MES_EXERCISE"),p;var c=$.grep(t["public"].exercises,function(e){return e._id===i});if(!a&&0===c.length)return p.reject("MES_EXERCISE"),p;c=c[0];var f=Db.getRefs().exercises[i],v=f.max*o.weight;if(!a&&(WEIGHT_MIN>n||n>v))return p.reject("MES_WEIGHT"),p;if(!a&&REPEATS_MIN>u)return p.reject("MES_REPEATS_MIN"),p;if(!a&&u>REPEATS_MAX)return p.reject("MES_REPEATS_MAX"),p;var d={success:!0,id:i,weight:n,plan:u},l=module.exports.getTotalWeightMax(t,i);if(n>l&&f.energy>t["private"].energy)return p.reject("MES_ENERGY"),p;var E,M,g=module.exports.getRepeatsAndEff(t,i,n,l),_=u>0?u:g.repeatsMax,h=Math.floor(_<g.repeatsMax?_:g.repeatsMax);if(n>l)M=.5,E=f.energy;else if(M=Curve.getRepeatsEffect(_),E=Math.ceil(h/g.repeatsMax*f.energy),E>t["private"].energy)return p.reject("MES_ENERGY"),p;var y=g.weightEffect*M*.3*(h/g.repeatsMax);if(d.effect=y,d.fact=g.repeatsMax,d.energy=-E,c&&h>=1){var x=c.pr||0;if(n>x){c&&(c.pr=n);var S=Rank.update(t);null!==S&&(d.rank=S),d.pr=!0}var R=f.wr;n>(R?R.value:0)&&(f.wr={value:n,_id:t._id},Db.update("exercises",i,{$set:{wr:f.wr}}),d.wr=!0)}return t["private"].energy-=E,setFrazzle(t,f,y,E),e.isDirty=!0,p.resolve(d),p}}};