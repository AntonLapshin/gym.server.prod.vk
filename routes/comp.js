function setFrazzle(e,r,t){var s=e["private"].frazzle,a=e["private"].stress,o=e["private"].tonus;r.body.forEach(function(e,r){var u=s[e._id]+e.stress*t;u>1&&(u=1);var i=a[e._id]+(e.stress<.5?e.stress/5:e.stress)*t;i>1&&(i=1);var c=e._id,p=.025*i;p-=p*(o[c]/TONUS_MAX),o[c]+=$.round(p),o[c]>TONUS_MAX&&(o[c]=TONUS_MAX),s[c]=$.round(u),a[c]=$.round(i)})}var Db=require("../db"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Coach=require("../controllers/coach"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),Workout=require("./workout"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10,TONUS_MAX=10;module.exports={start:{params:{id:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),s=e.player,a=r.id,o=Rank.getCatIndex(s["public"].mass||45),u=$.getComp(o).comps[a],i=u.uid;return s["public"].comp&&s["public"].comp[a]&&"started"==s["public"].comp[a].status&&s["public"].comp[a].uid==i?(t.reject("COMPPOWER_ALREADY_STARTED"),t):s["public"].comp&&s["public"].comp[a]&&"finished"==s["public"].comp[a].status&&s["public"].comp[a].uid==i?(t.reject("COMPPOWER_FINISHED"),t):(s["public"].comp||(s["public"].comp={}),s["public"].comp[a]={uid:i,status:"started",index:0,attempts:[]},e.isDirty=!0,t.resolve({success:!0}),t)}},getPrize:{params:{},handler:function(e,r){var t=e.player,s=t["public"].comp,a=0,o=0,u=[];for(var i in s){var c=s[i];"results"===c.status&&(c.status="end",a+=c.gold||0,o+=c.money||0,c.award&&(t["public"].awards.push(c.award),u.push(c.award)),e.isDirty=!0)}var p={success:!0};a&&(t["private"].gold+=a,p.gold=a),o&&(t["private"].money+=o,p.money=o),u.length>0&&(p.awards=u);var n=$.Deferred();return n.resolve(p),n}},get:{params:{},handler:function(e,r){var t=Rank.getCatIndex(e.player["public"].mass||45),s=$.Deferred();return Db.getColl("comp").findOne({_id:t},{"comps.members":0},function(e,r){s.resolve(r.comps)}),s}},execute:{params:{weight:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=e.player,s=$.Deferred();if(!t["public"].comp)return s.reject("COMPPOWER_NOTSTARTED"),s;var a=t["public"].comp[0],o=a.index;if(o>8)return s.reject("COMPPOWER_FINISHED"),s;var u=Math.floor(o/3),i=0===u?3:1===u?2:4;return r.gymId=3,r.exerciseId=i,r.repeats=1,r.comp=1,Workout.execute.handler(e,r).then(function(e){function u(r){a.status="finished",a.sum=r;var o=Rank.getCatIndex(t["public"].mass||45),u=(new Date).getTime(),i={id:t._id,sum:r,mass:t["public"].mass||45};GLOBAL.GYM.COMPS[o].comps[0].members.push(i),GLOBAL.GYM.COMPS[o].comps[0].last=u,GLOBAL.GYM.COMPS[o].comps[0].q++,Db.update("comp",o,{$push:{"comps.0.members":{$each:[i],$sort:{sum:-1}}},$inc:{"comps.0.q":1},$set:{"comps.0.last":u}}).then(function(r){s.resolve(e)})}if(e.fact>=1){if(a.attempts.push(r.weight),8===o){for(var i=0,c=0;9>c;c+=3){for(var p=0,n=0;3>n;n++){var d=a.attempts[c+n];d>p&&(p=d)}i+=p}return void u(i)}}else if(a.attempts.push(0),o%3===0)return void u(0);a.index++,s.resolve(e)},s.reject),s}}};