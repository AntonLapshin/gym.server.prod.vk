function setFrazzle(e,r,t){var s=e["private"].frazzle,a=e["private"].stress,u=e["private"].tonus;r.body.forEach(function(e,r){var i=s[e._id]+e.stress*t;i>1&&(i=1);var o=a[e._id]+(e.stress<.5?e.stress/5:e.stress)*t;o>1&&(o=1);var c=e._id,p=.025*o;p-=p*(u[c]/TONUS_MAX),u[c]+=$.round(p),u[c]>TONUS_MAX&&(u[c]=TONUS_MAX),s[c]=$.round(i),a[c]=$.round(o)})}var Db=require("../db"),$=require("jquery-deferred"),Curve=require("../controllers/curve"),Coach=require("../controllers/coach"),Rank=require("../controllers/rank"),Stimul=require("../controllers/stimul"),Workout=require("./workout"),WEIGHT_MIN=0,REPEATS_MIN=0,REPEATS_MAX=200,COEFF_POWER=7,COEFF_FRAZZLE=10,TONUS_MAX=10;module.exports={start:{params:{id:{required:!0,parseMethod:parseInt}},handler:function(e,r){var t=$.Deferred(),s=e.player,a=r.id,u=Rank.getCatIndex(s["public"].mass||45),i=$.getComp(u).comps[a],o=i.uid;return s["public"].comp&&s["public"].comp[a]&&"started"==s["public"].comp[a].status&&s["public"].comp[a].uid==o?(t.reject("COMPPOWER_ALREADY_STARTED"),t):s["public"].comp&&s["public"].comp[a]&&"finished"==s["public"].comp[a].status&&s["public"].comp[a].uid==o?(t.reject("COMPPOWER_FINISHED"),t):(s["public"].comp||(s["public"].comp={}),s["public"].comp[a]={uid:o,status:"started",index:0,attempts:[]},e.isDirty=!0,t.resolve({success:!0}),t)}},getPrize:{params:{},handler:function(e,r){var t=e.player,s=t["public"].comp,a=0,u=0,i=[];for(var o in s){var c=s[o];"results"===c.status&&(c.status="end",a+=c.gold||0,u+=c.money||0,c.award&&(t["public"].awards.push(c.award),i.push(c.award)),e.isDirty=!0)}var p={success:!0};a&&(t["private"].gold+=a,p.gold=a),u&&(t["private"].money+=u,p.money=u),i.length>0&&(p.awards=i);var n=$.Deferred();return n.resolve(p),n}},get:{params:{},handler:function(e,r){var t=Rank.getCatIndex(e.player["public"].mass||45),s=$.Deferred();return Db.getColl("comp").findOne({_id:t},{"comps.members":0},function(e,r){s.resolve(r.comps)}),s}},execute:{params:{weight:{required:!0,parseMethod:parseFloat}},handler:function(e,r){var t=e.player,s=$.Deferred();if(!t["public"].comp)return s.reject("COMPPOWER_NOTSTARTED"),s;var a=t["public"].comp[0],u=a.index;if(u>8)return s.reject("COMPPOWER_FINISHED"),s;var i=Math.floor(u/3),o=0===i?3:1===i?2:4;return r.gymId=3,r.exerciseId=o,r.repeats=1,r.comp=1,Workout.execute.handler(e,r).then(function(e){function i(r){a.status="finished",a.sum=r;var u=Rank.getCatIndex(t["public"].mass||45),i=(new Date).getTime(),o={id:t._id,sum:r,mass:t["public"].mass||45},c=$.getComp(u).comps;c[0].members.push(o),c[0].last=i,c[0].q++,Db.update("comp",u,{$push:{"comps.0.members":{$each:[o],$sort:{sum:-1}}},$inc:{"comps.0.q":1},$set:{"comps.0.last":i}}).then(function(r){s.resolve(e)})}if(e.fact>=1){if(a.attempts.push(r.weight),8===u){for(var o=0,c=0;9>c;c+=3){for(var p=0,n=0;3>n;n++){var d=a.attempts[c+n];d>p&&(p=d)}o+=p}return void i(o)}}else if(a.attempts.push(0),u%3===0)return void i(0);a.index++,s.resolve(e)},s.reject),s}}};